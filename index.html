<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2F3BA2">
    <title>Reconocimiento de Señas</title>
    <!-- Enlace a la biblioteca de TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <!-- Vinculación del manifiesto para PWA -->
    <link rel="manifest" href="/teachable-machine-model/manifest.json">
</head>
<body>
    <h1>Reconocimiento de Señas del Lenguaje de Señas Mexicano</h1>
    <video id="webcam" autoplay playsinline></video>
    <div id="prediction"></div>

    <script>
        // Variables globales
        let model, webcam, maxPredictions;

        // Cargar el modelo de Teachable Machine
        async function init() {
            // URL del modelo exportado desde Teachable Machine
            const modelURL = 'https://jorgetorres15.github.io/teachable-machine-model/model.json';
            model = await tf.loadLayersModel(modelURL);
            maxPredictions = model.outputShape[1]; // número de clases que el modelo puede predecir

            // Configuración de la cámara
            webcam = await setupWebcam();
            predict();
        }

        // Configurar la cámara
        async function setupWebcam() {
            const webcamElement = document.getElementById("webcam");
            const stream = await navigator.mediaDevices.getUserMedia({
                video: true
            });
            webcamElement.srcObject = stream;
            return webcamElement;
        }

        // Realizar predicciones en tiempo real
        async function predict() {
            while (true) {
                // Capturar la imagen de la cámara
                const video = tf.browser.fromPixels(webcam);
                const resized = tf.image.resizeBilinear(video, [224, 224]);
                const normalized = resized.div(255);
                const batch = normalized.expandDims(0);
                
                // Hacer la predicción
                const prediction = await model.predict(batch).data();
                const highestIndex = prediction.indexOf(Math.max(...prediction));

                // Mostrar el resultado
                document.getElementById("prediction").innerText = `Predicción: ${highestIndex}`;
                
                // Liberar memoria
                video.dispose();
                resized.dispose();
                normalized.dispose();
                batch.dispose();

                await tf.nextFrame();
            }
        }

        init();
    </script>

    <!-- Registro del Service Worker -->
    <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/teachable-machine-model/service-worker.js').then((registration) => {
            console.log('Service Worker registrado con éxito:', registration);
        }).catch((error) => {
            console.log('Error al registrar el Service Worker:', error);
        });
    }
</script>
</body>
</html>
